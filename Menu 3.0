<# 
IES Camp de Morvedre - Proyecto Aula Informatica (Windows)
Menu PowerShell: usuarios/grupos + gestor documental + permisos + seguridad + logs + limpieza
Autor: Cristian
#>

# ===============================
# CONFIGURACION
# ===============================
$BasePath = "D:\GestorDocumental"     # Cambia si tu disco de datos no es D:
$LogPath  = "C:\Temp\IES_Aula.log"
$PasswordPlain = "Camp2025!"          # Cambia la contrasena
$PasswordSecure = ConvertTo-SecureString $PasswordPlain -AsPlainText -Force

$UsuariosESO   = @("1ESO","2ESO","3ESO","4ESO")
$UsuariosBACH  = @("1BACH","2BACH")
$UsuariosDAW   = @("1DAW")
$UsuariosExtra = @("alumnado","profesorado")
$AdminSistema  = "administrador"

$Grupos = @("ESO","BACH","DAW","Alumnado","Profesorado")

# ===============================
# BUILTIN / CUENTAS GENERICAS
# ===============================
function Get-AccountFromSid([string]$sid) {
    return (New-Object System.Security.Principal.SecurityIdentifier($sid)).Translate([System.Security.Principal.NTAccount]).Value
}

# FIX DEFINITIVO: Add-LocalGroupMember NO traga "BUILTIN\...." en muchas versiones.
# En Windows en ESPAÑOL el grupo se llama así:
$BuiltinAdminsGroup = "Administradores"

# Para icacls /remove usamos cuentas por SID (funcionan en cualquier idioma)
$BuiltinUsersAccount = Get-AccountFromSid "S-1-5-32-545" # BUILTIN\Users o BUILTIN\Usuarios
$AuthUsersAccount    = Get-AccountFromSid "S-1-5-11"     # NT AUTHORITY\Authenticated Users
$EveryoneAccount     = Get-AccountFromSid "S-1-1-0"      # Everyone / Todos

# ===============================
# UTILIDADES
# ===============================
function Ensure-Admin {
    $isAdmin = ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()
    ).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)

    if (-not $isAdmin) {
        Write-Host "ERROR: Ejecuta PowerShell como Administrador." -ForegroundColor Red
        Pause
        exit 1
    }
}

function Write-Log {
    param([string]$Message)
    $dir = Split-Path $LogPath -Parent
    if (-not (Test-Path $dir)) { New-Item -ItemType Directory -Path $dir -Force | Out-Null }
    $stamp = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
    Add-Content -Path $LogPath -Value "[$stamp] $Message"
}

function Safe-Run {
    param(
        [scriptblock]$Action,
        [string]$OkMessage,
        [string]$ErrMessage
    )
    try {
        & $Action
        if ($OkMessage) { Write-Host $OkMessage -ForegroundColor Green; Write-Log $OkMessage }
    } catch {
        $msg = "$ErrMessage :: $($_.Exception.Message)"
        Write-Host $msg -ForegroundColor Red
        Write-Log $msg
    }
}

function Take-OwnershipTree([string]$Path) {
    if (-not (Test-Path $Path)) { return }
    Safe-Run { cmd /c "takeown /F `"$Path`" /R /D Y >nul" } "" "Error takeown en $Path"
    Safe-Run { cmd /c "icacls `"$Path`" /grant `"$BuiltinAdminsGroup`":(OI)(CI)F /T /C >nul" } "" "Error icacls grant admins en $Path"
}

# ===============================
# 1) USUARIOS Y GRUPOS
# ===============================
function Crear-Grupos {
    foreach ($g in $Grupos) {
        if (-not (Get-LocalGroup -Name $g -ErrorAction SilentlyContinue)) {
            New-LocalGroup -Name $g -Description "Grupo $g del IES Camp de Morvedre"
            Write-Host "Grupo creado: $g" -ForegroundColor Green
            Write-Log "Grupo creado: $g"
        } else {
            Write-Host "Grupo ya existe: $g" -ForegroundColor Yellow
            Write-Log "Grupo ya existe: $g"
        }
    }
}

function Crear-Usuario {
    param(
        [string]$Name,
        [string]$Description,
        [switch]$Admin
    )

    # Si ya existe, no falla: lo deja como OK
    if (Get-LocalUser -Name $Name -ErrorAction SilentlyContinue) {
        Write-Host "Usuario ya existe (se omite creacion): $Name" -ForegroundColor Yellow
        Write-Log  "Usuario ya existe (se omite creacion): $Name"

        if ($Admin) {
            try { Add-LocalGroupMember -Group $BuiltinAdminsGroup -Member $Name -ErrorAction Stop } catch {}
        }
        return
    }

    try {
        New-LocalUser `
            -Name $Name `
            -Password $PasswordSecure `
            -FullName $Name `
            -Description $Description `
            -PasswordNeverExpires `
            -UserMayNotChangePassword `
            -ErrorAction Stop

        Write-Host "Usuario creado: $Name" -ForegroundColor Green
        Write-Log "Usuario creado: $Name"

        if ($Admin) {
            Add-LocalGroupMember -Group $BuiltinAdminsGroup -Member $Name -ErrorAction Stop
            Write-Host "Usuario $Name agregado a $BuiltinAdminsGroup" -ForegroundColor Green
            Write-Log "Usuario $Name agregado a $BuiltinAdminsGroup"
        }
    } catch {
        Write-Host "Error creando usuario ${Name}: $($_.Exception.Message)" -ForegroundColor Red
        Write-Log  "Error creando usuario ${Name}: $($_.Exception.Message)"
    }
}

function Asignar-Grupos {
    foreach ($u in $UsuariosESO)  { if (Get-LocalUser -Name $u -ErrorAction SilentlyContinue) { Add-LocalGroupMember -Group "ESO"  -Member $u -ErrorAction SilentlyContinue } }
    foreach ($u in $UsuariosBACH) { if (Get-LocalUser -Name $u -ErrorAction SilentlyContinue) { Add-LocalGroupMember -Group "BACH" -Member $u -ErrorAction SilentlyContinue } }
    foreach ($u in $UsuariosDAW)  { if (Get-LocalUser -Name $u -ErrorAction SilentlyContinue) { Add-LocalGroupMember -Group "DAW"  -Member $u -ErrorAction SilentlyContinue } }

    if (Get-LocalUser -Name "alumnado" -ErrorAction SilentlyContinue)     { Add-LocalGroupMember -Group "Alumnado"     -Member "alumnado"     -ErrorAction SilentlyContinue }
    if (Get-LocalUser -Name "profesorado" -ErrorAction SilentlyContinue)  { Add-LocalGroupMember -Group "Profesorado"  -Member "profesorado"  -ErrorAction SilentlyContinue }

    Write-Host "Usuarios agregados a grupos." -ForegroundColor Green
    Write-Log "Usuarios agregados a grupos."
}

function Crear-Usuarios-Todos {
    foreach ($u in $UsuariosESO)   { Crear-Usuario -Name $u -Description "Usuario del curso $u (ESO)" }
    foreach ($u in $UsuariosBACH)  { Crear-Usuario -Name $u -Description "Usuario del curso $u (BACH)" }
    foreach ($u in $UsuariosDAW)   { Crear-Usuario -Name $u -Description "Usuario administrador DAW" -Admin }
    foreach ($u in $UsuariosExtra) { Crear-Usuario -Name $u -Description "Usuario general $u" }

    Crear-Usuario -Name $AdminSistema -Description "Cuenta administrativa del sistema" -Admin

    Asignar-Grupos
}

function Aplicar-Horarios {
    Safe-Run { net user 1ESO /time:M-F,08:00-09:00 }   "Horario aplicado: 1ESO"   "Error horario 1ESO"
    Safe-Run { net user 2ESO /time:M-F,09:00-10:00 }   "Horario aplicado: 2ESO"   "Error horario 2ESO"
    Safe-Run { net user 3ESO /time:M-F,10:00-11:00 }   "Horario aplicado: 3ESO"   "Error horario 3ESO"
    Safe-Run { net user 4ESO /time:M-F,11:00-12:00 }   "Horario aplicado: 4ESO"   "Error horario 4ESO"
    Safe-Run { net user 1BACH /time:M-F,12:00-13:00 }  "Horario aplicado: 1BACH"  "Error horario 1BACH"
    Safe-Run { net user 2BACH /time:M-F,13:00-14:00 }  "Horario aplicado: 2BACH"  "Error horario 2BACH"
    Safe-Run { net user 1DAW /time:M-F,08:00-14:00 }   "Horario aplicado: 1DAW"   "Error horario 1DAW"
    Safe-Run { net user alumnado /time:M-F,08:00-21:00 }    "Horario aplicado: alumnado"    "Error horario alumnado"
    Safe-Run { net user profesorado /time:M-F,08:00-21:00 } "Horario aplicado: profesorado" "Error horario profesorado"
    Write-Host "Horarios configurados." -ForegroundColor Green
    Write-Log "Horarios configurados."
}

function Ocultar-Lista-Usuarios {
    $RegPath = "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon"
    Safe-Run { Set-ItemProperty -Path $RegPath -Name "DontDisplayLastUserName" -Value 1 } `
        "Ocultacion de usuarios en login activada." `
        "Error al configurar ocultacion de login"
}

# ===============================
# 2) GESTOR DOCUMENTAL
# ===============================
function Crear-Estructura-Carpetas {
    $paths = @(
        "$BasePath\ESO\1ESO", "$BasePath\ESO\2ESO", "$BasePath\ESO\3ESO", "$BasePath\ESO\4ESO",
        "$BasePath\BACH\1BACH", "$BasePath\BACH\2BACH",
        "$BasePath\DAW\1DAW"
    )
    Safe-Run { New-Item -ItemType Directory -Path $paths -Force | Out-Null } `
        "Estructura de carpetas creada en $BasePath" `
        "Error creando estructura de carpetas"
}

function Set-Permisos-Base {
    param([string]$Path)

    if (-not (Test-Path $Path)) { return }

    Take-OwnershipTree -Path $Path

    Safe-Run { icacls $Path /inheritance:r | Out-Null } "Herencia deshabilitada en $Path" "Error deshabilitando herencia $Path"
    Safe-Run { icacls $Path /remove:g "$BuiltinUsersAccount" "$AuthUsersAccount" "$EveryoneAccount" 2>$null | Out-Null } "" ""
    Safe-Run { icacls $Path /grant "${BuiltinAdminsGroup}:(OI)(CI)F" "SYSTEM:(OI)(CI)F" | Out-Null } `
        "Permisos base aplicados (Admins/SYSTEM) en $Path" `
        "Error aplicando permisos base en $Path"
}

function Aplicar-Permisos {
    if (-not (Test-Path $BasePath)) {
        Write-Host "ERROR: No existe $BasePath. Crea la estructura primero." -ForegroundColor Red
        return
    }

    Set-Permisos-Base -Path $BasePath
    Safe-Run { icacls $BasePath /grant "ESO:(OI)(CI)RX" "BACH:(OI)(CI)RX" "DAW:(OI)(CI)RX" | Out-Null } `
        "Permisos de acceso (RX) a BasePath para ESO/BACH/DAW" `
        "Error aplicando permisos a BasePath"

    foreach ($stage in @("ESO","BACH","DAW")) {
        $p = Join-Path $BasePath $stage
        if (Test-Path $p) {
            Set-Permisos-Base -Path $p
            Safe-Run { icacls $p /grant "${stage}:(OI)(CI)RX" | Out-Null } `
                "Permisos (RX) aplicados en $p para $stage" `
                "Error aplicando permisos en $p"
        }
    }

    foreach ($curso in $UsuariosESO) {
        $folder = "$BasePath\ESO\$curso"
        if (Test-Path $folder) {
            Set-Permisos-Base -Path $folder
            Safe-Run { icacls $folder /grant "${curso}:(OI)(CI)M" "ESO:(OI)(CI)RX" | Out-Null } `
                "Permisos en $folder (M para $curso, RX para ESO)" `
                "Error permisos en $folder"
        }
    }

    foreach ($curso in $UsuariosBACH) {
        $folder = "$BasePath\BACH\$curso"
        if (Test-Path $folder) {
            Set-Permisos-Base -Path $folder
            Safe-Run { icacls $folder /grant "${curso}:(OI)(CI)M" "BACH:(OI)(CI)RX" | Out-Null } `
                "Permisos en $folder (M para $curso, RX para BACH)" `
                "Error permisos en $folder"
        }
    }

    $dawFolder = "$BasePath\DAW\1DAW"
    if (Test-Path $dawFolder) {
        Set-Permisos-Base -Path $dawFolder
        Safe-Run { icacls $dawFolder /grant "1DAW:(OI)(CI)M" "DAW:(OI)(CI)RX" | Out-Null } `
            "Permisos en $dawFolder (M para 1DAW, RX para DAW)" `
            "Error permisos en $dawFolder"
    }

    Write-Host "Permisos NTFS configurados." -ForegroundColor Green
    Write-Log "Permisos NTFS configurados."
}

# ===============================
# 3) VALIDACION RAPIDA
# ===============================
function Validacion-Rapida {
    Write-Host "=== VALIDACION RAPIDA ===" -ForegroundColor Cyan

    $checkUsers = $UsuariosESO + $UsuariosBACH + $UsuariosDAW + $UsuariosExtra + @($AdminSistema)
    foreach ($u in $checkUsers) {
        $exists = Get-LocalUser -Name $u -ErrorAction SilentlyContinue
        if ($exists) { Write-Host "OK usuario: $u" -ForegroundColor Green }
        else { Write-Host "FALTA usuario: $u" -ForegroundColor Red }
    }

    $checkFolders = @(
        "$BasePath\ESO\1ESO","$BasePath\ESO\2ESO","$BasePath\ESO\3ESO","$BasePath\ESO\4ESO",
        "$BasePath\BACH\1BACH","$BasePath\BACH\2BACH",
        "$BasePath\DAW\1DAW"
    )
    foreach ($f in $checkFolders) {
        if (Test-Path $f) { Write-Host "OK carpeta: $f" -ForegroundColor Green }
        else { Write-Host "FALTA carpeta: $f" -ForegroundColor Red }
    }

    Write-Host "Revision rapida finalizada." -ForegroundColor Cyan
    Write-Log "Validacion rapida ejecutada."
}

# ===============================
# 4) LIMPIEZA COMPLETA (RESET)
# ===============================
function Limpiar-Todo {
    Write-Host "==========================================" -ForegroundColor Red
    Write-Host "  LIMPIEZA COMPLETA DEL SISTEMA" -ForegroundColor Red
    Write-Host "  BORRA USUARIOS/GRUPOS/CARPETAS DEL PROYECTO" -ForegroundColor Red
    Write-Host "==========================================" -ForegroundColor Red

    $confirm = Read-Host "Escribe BORRAR para confirmar"
    if ($confirm -ne "BORRAR") {
        Write-Host "Operacion cancelada." -ForegroundColor Yellow
        return
    }

    Write-Host "Iniciando limpieza..." -ForegroundColor Cyan
    Write-Log "Inicio limpieza completa"

    if (Test-Path $BasePath) {
        try {
            Take-OwnershipTree -Path $BasePath
            icacls $BasePath /reset /T /C | Out-Null
            Remove-Item -Path $BasePath -Recurse -Force
            Write-Host "Gestor documental eliminado." -ForegroundColor Green
            Write-Log "Gestor documental eliminado"
        } catch {
            Write-Host "Error eliminando gestor documental: $($_.Exception.Message)" -ForegroundColor Red
            Write-Log "Error eliminando gestor documental: $($_.Exception.Message)"
        }
    } else {
        Write-Host "No existe el gestor documental." -ForegroundColor Yellow
        Write-Log "No existe el gestor documental"
    }

    $UsuariosABorrar = $UsuariosESO + $UsuariosBACH + $UsuariosDAW + $UsuariosExtra + @($AdminSistema)
    foreach ($u in $UsuariosABorrar) {
        if (Get-LocalUser -Name $u -ErrorAction SilentlyContinue) {
            try {
                Remove-LocalUser -Name $u
                Write-Host "Usuario eliminado: $u" -ForegroundColor Green
                Write-Log "Usuario eliminado: $u"
            } catch {
                Write-Host "Error eliminando usuario ${u}: $($_.Exception.Message)" -ForegroundColor Red
                Write-Log  "Error eliminando usuario ${u}: $($_.Exception.Message)"
            }
        }
    }

    foreach ($g in $Grupos) {
        if (Get-LocalGroup -Name $g -ErrorAction SilentlyContinue) {
            try {
                Remove-LocalGroup -Name $g
                Write-Host "Grupo eliminado: $g" -ForegroundColor Green
                Write-Log "Grupo eliminado: $g"
            } catch {
                Write-Host "Error eliminando grupo ${g}: $($_.Exception.Message)" -ForegroundColor Red
                Write-Log  "Error eliminando grupo ${g}: $($_.Exception.Message)"
            }
        }
    }

    Write-Host "==========================================" -ForegroundColor Cyan
    Write-Host " LIMPIEZA COMPLETADA" -ForegroundColor Cyan
    Write-Host "==========================================" -ForegroundColor Cyan
    Write-Log "Limpieza completa finalizada"
}

# ===============================
# MENU
# ===============================
function Show-Menu {
    Clear-Host
    Write-Host "==========================================" -ForegroundColor Cyan
    Write-Host " IES Camp de Morvedre - Proyecto Aula (Win)" -ForegroundColor Cyan
    Write-Host "==========================================" -ForegroundColor Cyan
    Write-Host "1) Crear grupos"
    Write-Host "2) Crear usuarios + asignar grupos"
    Write-Host "3) Aplicar horarios"
    Write-Host "4) Ocultar lista de usuarios en login"
    Write-Host "5) Crear estructura gestor documental"
    Write-Host "6) Aplicar permisos NTFS (icacls)"
    Write-Host "7) Validacion rapida"
    Write-Host "8) Ejecutar TODO (1-6)"
    Write-Host "9) LIMPIEZA COMPLETA (reset del sistema)"
    Write-Host "0) Salir"
    Write-Host ""
}

function Ejecutar-Todo {
    Crear-Grupos
    Crear-Usuarios-Todos
    Aplicar-Horarios
    Ocultar-Lista-Usuarios
    Crear-Estructura-Carpetas
    Aplicar-Permisos
}

# ===============================
# MAIN
# ===============================
Ensure-Admin

do {
    Show-Menu
    $op = Read-Host "Selecciona una opcion"

    switch ($op) {
        "1" { Crear-Grupos; Pause }
        "2" { Crear-Usuarios-Todos; Pause }
        "3" { Aplicar-Horarios; Pause }
        "4" { Ocultar-Lista-Usuarios; Pause }
        "5" { Crear-Estructura-Carpetas; Pause }
        "6" { Aplicar-Permisos; Pause }
        "7" { Validacion-Rapida; Pause }
        "8" { Ejecutar-Todo; Pause }
        "9" { Limpiar-Todo; Pause }
        "0" { Write-Host "Saliendo..." -ForegroundColor Yellow; Write-Log "Script finalizado"; }
        default { Write-Host "Opcion no valida." -ForegroundColor Red; Pause }
    }
} while ($op -ne "0")
